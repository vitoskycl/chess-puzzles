<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Web Puzzle FEN</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="static/css/chessboard-1.0.0.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
  <script src="static/js/chessboard-1.0.0.js"></script>

  <style>
 /* Tablero adaptable */
#board {
  width: min(90vw, 400px);
  max-width: 400px;
}

/* En pantallas grandes: tablero y barra al lado */
@media (min-width: 768px) {
  .board-wrapper {
    flex-direction: row !important;
  }

  .progress-container {
    height: 400px !important;
    width: 25px !important;
  }

  .progress-container .progress {
    rotate: 180deg;
    width: 100%;
    height: 100%;
  }

  .progress-container .progress-bar {
    width: 100%;
    height: 0%;
    transition: height 0.3s;
  }
}

/* En pantallas peque√±as: tablero arriba, barra horizontal abajo */
@media (max-width: 767px) {
  .board-wrapper {
    flex-direction: column !important;
  }

  .progress-container {
    height: 25px !important;
    width: 90% !important;
    rotate: 0deg !important;
  }

  .progress-container .progress {
    rotate: 0deg !important;
    width: 100%;
    height: 100%;
  }

  .progress-container .progress-bar {
    height: 100%;
    width: 0%;
    transition: width 0.3s;
  }
}
    .btn { margin: 2px; }
    .white-1e1d7 { background-color: #eeeed2 !important; }
    .black-3c85d { background-color: #769656 !important; }
    tr.table-active td { background-color: #b8daff !important; }
    .square-in-check {
  box-shadow: inset 0 0 0 4px red !important;
}
  .piece-417db {
    z-index: 2000 !important; /* asegura que las piezas se vean encima */
    cursor: grab;
  }
  .piece-417db.dragging {
    opacity: 0.8;
  }
  </style>
</head>
<body class="bg-light">

<div class="container py-4">
  <h1 class="mb-4">Selecciona el Puzzle y trata de resolverlo</h1>

  <!-- Filtros -->
  <div class="row mb-3">
    <div class="col-md-3">
      <label for="winnerFilter" class="form-label">Ganador</label>
      <select id="winnerFilter" class="form-select">
        <option value="">Todos</option>
        <option value="White">Blancas</option>
        <option value="Black">Negras</option>
      </select>
    </div>
    <div class="col-md-3">
      <label for="mateFilter" class="form-label">Mate En</label>
      <select id="mateFilter" class="form-select">
        <option value="">Todos</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
      </select>
    </div>
    <div class="col-md-3 align-self-end">
      <button class="btn btn-secondary" onclick="applyFilters()">Filtrar</button>
      <button class="btn btn-outline-secondary" onclick="resetFilters()">Reset</button>
    </div>
  </div>

  <!-- Tabla -->
  <table class="table table-bordered table-striped">
    <thead class="table-dark">
      <tr>
        <th>#</th>
        <th>FEN</th>
        <th>MeteEn</th>
        <th>Ganador</th>
        <th>Ver</th>
      </tr>
    </thead>
    <tbody id="fenTable"></tbody>
  </table>

  <!-- Info de paginaci√≥n y selector -->
  <div class="d-flex justify-content-between align-items-center mb-2">
    <div id="pageInfo"></div>
    <div>
      <label for="rowsPerPageSelect" class="form-label me-2">Filas por p√°gina:</label>
      <select id="rowsPerPageSelect" class="form-select d-inline-block" style="width: auto;">
        <option value="10" selected>10</option>
        <option value="15">15</option>
        <option value="20">20</option>
      </select>
    </div>
  </div>

  <!-- Paginaci√≥n -->
  <nav>
    <ul class="pagination justify-content-center">
      <li class="page-item"><a class="page-link" href="#" id="prevPage">Anterior</a></li>
      <li class="page-item"><a class="page-link" href="#" id="nextPage">Siguiente</a></li>
    </ul>
  </nav>
</div>

<!-- Modal -->
<div class="modal fade" id="fenModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Detalle del Puzzle</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <div class="board-wrapper d-flex flex-column flex-md-row justify-content-center align-items-center gap-3 mt-3">
          <!-- Tablero -->
          <div id="board" class="flex-shrink-0"></div>

          <!-- Barra de progreso -->
          <div class="progress-container d-flex align-items-end mt-3 mt-md-0" style="height: 100%; max-height: 400px; width: 25px;">
            <div class="progress" style="width: 100%; height: 100%; rotate: 180deg;">
              <div id="progressBar" class="progress-bar bg-success" role="progressbar"
                style="height: 0%; width: 100%; transition: height 0.3s;"></div>
            </div>
          </div>
        </div>
        <p class="mt-3">
          Mate en&nbsp;<strong><span id="mateIn"></span></strong>,&nbsp;mueven las&nbsp;<strong><span id="sideToMove"></span></strong>,&nbsp;pero ganan las&nbsp;<strong><span id="gananId"></span></strong>   
        </p>
        <button class="btn btn-sm btn-outline-primary" id="toggleMoves">üëÅÔ∏è Mostrar movimientos</button>
        <p class="mt-3 d-none" id="movesContainer">
          <strong>Movimientos:</strong> <span id="moves"></span>
        </p>
      </div>
    </div>
  </div>
</div>

<script>
let data = [];
let filteredData = [];
let currentPage = 1;
let rowsPerPage = 10;
let highlightedRow = null;
// Nuevas variables globales:
let game = null;
let board = null;

async function loadData() {
  try {
    const res = await fetch("../data/fens_mate_verificados.json");
    data = await res.json();
    filteredData = [...data];
    renderTable();
  } catch (e) {
    console.error("Error cargando JSON:", e);
    document.getElementById("pageInfo").textContent = "Error al cargar los datos.";
  }
}
function showSuccessMessage(msg) {
  const alert = document.createElement("div");
  alert.className = "alert alert-success position-fixed top-0 start-50 translate-middle-x mt-3";
  alert.style.zIndex = "3000";
  alert.textContent = msg;
  document.body.appendChild(alert);
  setTimeout(() => alert.remove(), 1500);
}

function showErrorMessage(msg) {
  const alert = document.createElement("div");
  alert.className = "alert alert-danger position-fixed top-0 start-50 translate-middle-x mt-3";
  alert.style.zIndex = "3000";
  alert.textContent = msg;
  document.body.appendChild(alert);
  setTimeout(() => alert.remove(), 2000);
}

function applyFilters() {
  const winner = document.getElementById("winnerFilter").value;
  const mate = document.getElementById("mateFilter").value;

  filteredData = data.filter(row => {
    let ok = true;
    if (winner && row.Winner !== winner) ok = false;
    if (mate && parseInt(row.MateIn) !== parseInt(mate)) ok = false;
    return ok;
  });

  currentPage = 1;
  renderTable();
}

function resetFilters() {
  document.getElementById("winnerFilter").value = "";
  document.getElementById("mateFilter").value = "";
  filteredData = [...data];
  currentPage = 1;
  renderTable();
}

function renderTable() {
  const table = document.getElementById("fenTable");
  table.innerHTML = "";

  let start = (currentPage - 1) * rowsPerPage;
  let end = start + rowsPerPage;
  let pageData = filteredData.slice(start, end);

  pageData.forEach((row, index) => {
    let tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${start + index + 1}</td>
      <td>${row.FEN}</td>
      <td>${row.MateIn}</td>
      <td>${(row.Winner === 'Black' ? 'Negras':'Blancas')}</td>
      <td><button class="btn btn-sm btn-primary" onclick="showFen('${row.Winner}', '${row.FEN}', '${row.Moves.replace(/'/g, "\\'")}', '${row.MateIn}', this)">üëÅÔ∏è</button></td>
    `;
    table.appendChild(tr);
  });

  const total = filteredData.length;
  const totalPages = Math.ceil(total / rowsPerPage);
  const pageInfo = document.getElementById("pageInfo");
  pageInfo.textContent = total
    ? `Mostrando ${start + 1}-${Math.min(end, total)} de ${total} resultados (p√°gina ${currentPage} de ${totalPages})`
    : "Sin resultados";
}
    function highlightKingInCheck() {
      // Elimina cualquier resaltado anterior
      document.querySelectorAll('.square-55d63').forEach(sq => {
        sq.classList.remove('square-in-check');
      });

      if (game && game.in_check()) {
        const fenParts = game.fen().split(' ');
        const turn = fenParts[1]; // 'w' o 'b'
        const boardObj = game.board();
        let kingSquare = null;

        for (let row = 0; row < 8; row++) {
          for (let col = 0; col < 8; col++) {
            const piece = boardObj[row][col];
            if (piece && piece.type === 'k' && piece.color === turn) {
              // fila 0 es 8, columna 0 es 'a'
              const file = String.fromCharCode('a'.charCodeAt(0) + col);
              const rank = (8 - row).toString();
              kingSquare = file + rank;
            }
          }
        }

        if (kingSquare) {
          const squareEl = document.querySelector(`.square-${kingSquare}`);
          if (squareEl) {
            squareEl.classList.add('square-in-check');
          }
        }
      }
    }
function showFen(winnerColor, fen, moves, mateIn, btn) {
  if (highlightedRow) highlightedRow.classList.remove("table-active");
  highlightedRow = btn.closest("tr");
  highlightedRow.classList.add("table-active");

  // Variables globales
  game = new Chess(fen);
  const moveList = moves.trim().split(/\s+/); // ej: ["a5b5", "a8a7", ...]
  let moveIndex = 0;

  // Funci√≥n auxiliar para reiniciar puzzle
  function resetPuzzle() {
    game = new Chess(fen);
    moveIndex = 0;
    board.position(fen);
    highlightKingInCheck(fen);
    showErrorMessage("‚ùå Incorrecto. Puzzle reiniciado.");
  }

  // Reiniciar barra de progreso cada vez que se abre un nuevo puzzle
const progressBar = document.getElementById("progressBar");
if (progressBar) {
  const isMobile = window.innerWidth < 768;
  if (isMobile) {
    progressBar.style.width = "0%";
    progressBar.style.height = "100%";
  } else {
    progressBar.style.height = "0%";
    progressBar.style.width = "100%";
  }
}
  board = Chessboard('board', {
    position: fen,
    pieceTheme: 'img/chesspieces/wikipedia/{piece}.png',
    draggable: true,
    onDragStart: (source, piece) => {
      if (game.game_over() ||
          (game.turn() === 'w' && piece.startsWith('b')) ||
          (game.turn() === 'b' && piece.startsWith('w'))) {
        return false;
      }
    },
    onDrop: (source, target) => {
   const expected = moveList[moveIndex];
  const userMove = source + target;
  const progressBar = document.getElementById("progressBar");

  const updateProgress = (percent) => {
    const isMobile = window.innerWidth < 768;
    if (isMobile) {
      progressBar.style.width = percent + "%";
      progressBar.style.height = "100%";
    } else {
      progressBar.style.height = percent + "%";
      progressBar.style.width = "100%";
    }
  };

  const resetProgress = () => updateProgress(0);

  if (userMove === expected) {
    const move = game.move({ from: source, to: target, promotion: 'q' });
    moveIndex++;
    highlightKingInCheck(game.fen());

    const progressPercent = Math.round((moveIndex / moveList.length) * 100);
    updateProgress(progressPercent);

    if (moveIndex >= moveList.length) {
      setTimeout(() => {
        updateProgress(100);
        showSuccessMessage("üéâ ¬°Puzzle completado!");
      }, 300);
    }
  } else {
    setTimeout(() => {
      resetPuzzle();
      resetProgress();
    }, 300);
    return 'snapback';
  }
    },
    onSnapEnd: () => board.position(game.fen())
  });

  highlightKingInCheck(fen);

  // Mostrar info del modal
  let sideToMove = fen.split(" ")[1] === "w" ? "Blancas" : "Negras";
  let textoGanan  = (winnerColor === "Black" ? "Negras" : "Blancas");
  document.getElementById("sideToMove").textContent = sideToMove;
  document.getElementById("mateIn").textContent = mateIn;
  document.getElementById("moves").textContent = moves;
  document.getElementById("gananId").textContent = textoGanan;
  document.getElementById("movesContainer").classList.add("d-none");

  let toggleBtn = document.getElementById("toggleMoves");
  toggleBtn.textContent = "üëÅÔ∏è Mostrar movimientos";
  toggleBtn.onclick = () => {
    let movesEl = document.getElementById("movesContainer");
    movesEl.classList.toggle("d-none");
    toggleBtn.textContent = movesEl.classList.contains("d-none")
      ? "üëÅÔ∏è Mostrar movimientos"
      : "üôà Ocultar movimientos";
  };

  let modal = new bootstrap.Modal(document.getElementById("fenModal"));
  modal.show();
}
document.getElementById("prevPage").addEventListener("click", e => {
  e.preventDefault();
  if (currentPage > 1) {
    currentPage--;
    renderTable();
  }
});

document.getElementById("nextPage").addEventListener("click", e => {
  e.preventDefault();
  if (currentPage * rowsPerPage < filteredData.length) {
    currentPage++;
    renderTable();
  }
});

document.getElementById("rowsPerPageSelect").addEventListener("change", e => {
  rowsPerPage = parseInt(e.target.value);
  currentPage = 1;
  renderTable();
});

loadData();
</script>
</body>
</html>
