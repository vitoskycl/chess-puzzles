<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Web Puzzle FEN</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="static/css/chessboard-1.0.0.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
  <script src="static/js/chessboard-1.0.0.js"></script>

  <style>
    #board { width: 500px; margin: auto; }
    .btn { margin: 2px; }
    .white-1e1d7 { background-color: #eeeed2 !important; }
    .black-3c85d { background-color: #769656 !important; }
    tr.table-active td { background-color: #b8daff !important; }
  </style>
</head>
<body class="bg-light">

<div class="container py-4">
  <h1 class="mb-4">FEN Puzzle Database</h1>

  <!-- Filtros -->
  <div class="row mb-3">
    <div class="col-md-3">
      <label for="winnerFilter" class="form-label">Winner</label>
      <select id="winnerFilter" class="form-select">
        <option value="">Todos</option>
        <option value="White">White</option>
        <option value="Black">Black</option>
      </select>
    </div>
    <div class="col-md-3">
      <label for="mateFilter" class="form-label">MateIn</label>
      <select id="mateFilter" class="form-select">
        <option value="">Todos</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
      </select>
    </div>
    <div class="col-md-3 align-self-end">
      <button class="btn btn-secondary" onclick="applyFilters()">Filtrar</button>
      <button class="btn btn-outline-secondary" onclick="resetFilters()">Reset</button>
    </div>
  </div>

  <!-- Tabla -->
  <table class="table table-bordered table-striped">
    <thead class="table-dark">
      <tr>
        <th>#</th>
        <th>FEN</th>
        <th>MateIn</th>
        <th>Winner</th>
        <th>Ver</th>
      </tr>
    </thead>
    <tbody id="fenTable"></tbody>
  </table>

  <!-- Info de paginaci√≥n y selector -->
  <div class="d-flex justify-content-between align-items-center mb-2">
    <div id="pageInfo"></div>
    <div>
      <label for="rowsPerPageSelect" class="form-label me-2">Filas por p√°gina:</label>
      <select id="rowsPerPageSelect" class="form-select d-inline-block" style="width: auto;">
        <option value="10" selected>10</option>
        <option value="15">15</option>
        <option value="20">20</option>
      </select>
    </div>
  </div>

  <!-- Paginaci√≥n -->
  <nav>
    <ul class="pagination justify-content-center">
      <li class="page-item"><a class="page-link" href="#" id="prevPage">Anterior</a></li>
      <li class="page-item"><a class="page-link" href="#" id="nextPage">Siguiente</a></li>
    </ul>
  </nav>
</div>

<!-- Modal -->
<div class="modal fade" id="fenModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Detalle del Puzzle</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <div id="board"></div>
        <p class="mt-3">
          <strong>Mueven las:</strong> <span id="sideToMove"></span> |
          <strong>MateIn:</strong> <span id="mateIn"></span>
        </p>
        <button class="btn btn-sm btn-outline-primary" id="toggleMoves">üëÅÔ∏è Mostrar movimientos</button>
        <p class="mt-3 d-none" id="movesContainer">
          <strong>Movimientos:</strong> <span id="moves"></span>
        </p>
      </div>
    </div>
  </div>
</div>

<script>
let data = [];
let filteredData = [];
let currentPage = 1;
let rowsPerPage = 10;
let highlightedRow = null;

async function loadData() {
  try {
    const res = await fetch("../data/fens_mate_verificados.json");
    data = await res.json();
    filteredData = [...data];
    renderTable();
  } catch (e) {
    console.error("Error cargando JSON:", e);
    document.getElementById("pageInfo").textContent = "Error al cargar los datos.";
  }
}

function applyFilters() {
  const winner = document.getElementById("winnerFilter").value;
  const mate = document.getElementById("mateFilter").value;

  filteredData = data.filter(row => {
    let ok = true;
    if (winner && row.Winner !== winner) ok = false;
    if (mate && parseInt(row.MateIn) !== parseInt(mate)) ok = false;
    return ok;
  });

  currentPage = 1;
  renderTable();
}

function resetFilters() {
  document.getElementById("winnerFilter").value = "";
  document.getElementById("mateFilter").value = "";
  filteredData = [...data];
  currentPage = 1;
  renderTable();
}

function renderTable() {
  const table = document.getElementById("fenTable");
  table.innerHTML = "";

  let start = (currentPage - 1) * rowsPerPage;
  let end = start + rowsPerPage;
  let pageData = filteredData.slice(start, end);

  pageData.forEach((row, index) => {
    let tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${start + index + 1}</td>
      <td>${row.FEN}</td>
      <td>${row.MateIn}</td>
      <td>${row.Winner}</td>
      <td><button class="btn btn-sm btn-primary" onclick="showFen('${row.FEN}', '${row.Moves.replace(/'/g, "\\'")}', '${row.MateIn}', this)">üëÅÔ∏è</button></td>
    `;
    table.appendChild(tr);
  });

  const total = filteredData.length;
  const totalPages = Math.ceil(total / rowsPerPage);
  const pageInfo = document.getElementById("pageInfo");
  pageInfo.textContent = total
    ? `Mostrando ${start + 1}-${Math.min(end, total)} de ${total} resultados (p√°gina ${currentPage} de ${totalPages})`
    : "Sin resultados";
}

function showFen(fen, moves, mateIn, btn) {
  if (highlightedRow) highlightedRow.classList.remove("table-active");
  highlightedRow = btn.closest("tr");
  highlightedRow.classList.add("table-active");

  let board = Chessboard('board', fen, {
    pieceTheme: 'static/img/chesspieces/wikipedia/{piece}.png',
    draggable: false
  });

  let sideToMove = fen.split(" ")[1] === "w" ? "Blancas" : "Negras";
  document.getElementById("sideToMove").textContent = sideToMove;
  document.getElementById("mateIn").textContent = mateIn;
  document.getElementById("moves").textContent = moves;
  document.getElementById("movesContainer").classList.add("d-none");

  let toggleBtn = document.getElementById("toggleMoves");
  toggleBtn.textContent = "üëÅÔ∏è Mostrar movimientos";
  toggleBtn.onclick = () => {
    let movesEl = document.getElementById("movesContainer");
    movesEl.classList.toggle("d-none");
    toggleBtn.textContent = movesEl.classList.contains("d-none")
      ? "üëÅÔ∏è Mostrar movimientos"
      : "üôà Ocultar movimientos";
  };

  let modal = new bootstrap.Modal(document.getElementById("fenModal"));
  modal.show();
}

document.getElementById("prevPage").addEventListener("click", e => {
  e.preventDefault();
  if (currentPage > 1) {
    currentPage--;
    renderTable();
  }
});

document.getElementById("nextPage").addEventListener("click", e => {
  e.preventDefault();
  if (currentPage * rowsPerPage < filteredData.length) {
    currentPage++;
    renderTable();
  }
});

document.getElementById("rowsPerPageSelect").addEventListener("change", e => {
  rowsPerPage = parseInt(e.target.value);
  currentPage = 1;
  renderTable();
});

loadData();
</script>
</body>
</html>
